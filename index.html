<!DOCTYPE html>
<html>
<head>
    <title>Web3 P2P Network</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; padding: 20px; background: #f3f4f6; max-width: 500px; margin: auto; }
        .box { background: white; padding: 20px; border-radius: 12px; shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; border-radius: 8px; border: 1px solid #ddd; }
        button { width: 100%; padding: 10px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        #messages { list-style: none; padding: 0; }
        li { background: white; padding: 10px; margin-bottom: 5px; border-radius: 8px; border-left: 4px solid #4f46e5; }
        .status { font-size: 0.8em; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>
    
    <div id="auth" class="box">
        <h3>Войти в Web3</h3>
        <input id="alias" placeholder="Логин">
        <input id="pass" type="password" placeholder="Пароль">
        <button onclick="signUp()">Создать аккаунт</button>
        <button onclick="signIn()" style="background:#10b981">Войти</button>
        <p style="font-size: 0.7em;">*Пароль нельзя восстановить, он генерирует ваш ключ.</p>
    </div>

    <div id="app" class="box" style="display:none">
            <div class="status">
            Статус: <span id="netStatus" style="color: red;">ОФФЛАЙН</span> 
            (Пиров: <span id="peerCount">0</span>)
        </div>
        <h3 id="userTitle"></h3>
        <div class="status">Статус: <span id="netStatus">Подключение...</span></div>
        <input id="content" placeholder="Что нового?">
        <button onclick="send()">Опубликовать в P2P</button>
        <ul id="messages"></ul>
    </div>


    <script>
    // Добавляем еще больше узлов для надежности
    const gun = Gun({
        peers: [
            'https://gun-manhattan.herokuapp.com/gun',
            'https://peer.wall.gl/gun',
            'https://gun-us.herokuapp.com/gun',
            'https://gun-eu.herokuapp.com/gun'
        ]
    });

    const user = gun.user();

    // Каждую секунду проверяем, сколько у нас живых соединений
    setInterval(() => {
        const peers = Object.keys(gun._.opt.peers).filter(url => {
            return gun._.opt.peers[url].wire && gun._.opt.peers[url].wire.readyState === 1;
        });
        document.getElementById('peerCount').innerText = peers.length;
        if (peers.length > 0) {
            document.getElementById('netStatus').innerText = 'ОНЛАЙН';
            document.getElementById('netStatus').style.color = 'green';
        } else {
            document.getElementById('netStatus').innerText = 'ОФФЛАЙН (ищу узлы...)';
            document.getElementById('netStatus').style.color = 'red';
        }
    }, 2000);

    const chatNode = gun.get('my-private-network-test-999'); // Новая чистая комната

    function updateUI() {
        if (user.is) {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('userTitle').innerText = "Вы: " + user.is.alias;
        }
    }

    // Загрузка работает ВСЕГДА, даже без логина
    chatNode.map().on((data, id) => {
        if (!data || !data.text) return;
        if (!document.getElementById(id)) {
            const li = document.createElement('li');
            li.id = id;
            li.style.borderLeft = "4px solid " + (data.from === "Kir" ? "blue" : "green");
            li.innerHTML = `<strong>${data.from}:</strong> ${data.text} <br><small>${new Date(data.time).toLocaleTimeString()}</small>`;
            document.getElementById('messages').prepend(li);
        }
    });

    async function signUp() {
        user.create(document.getElementById('alias').value, document.getElementById('pass').value, (ack) => {
            if (ack.err) alert(ack.err);
            else signIn();
        });
    }

    function signIn() {
        user.auth(document.getElementById('alias').value, document.getElementById('pass').value, (ack) => {
            if (ack.err) alert(ack.err);
            else updateUI();
        });
    }

    function send() {
        const text = document.getElementById('content').value;
        const name = user.is ? user.is.alias : "Аноним";
        if (!text) return;
        
        chatNode.set({
            text: text,
            from: name,
            time: Date.now()
        });
        document.getElementById('content').value = '';
    }

    updateUI();
</script>
</body>
</html>