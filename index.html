<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–æ—è P2P –°–æ—Ü—Å–µ—Ç—å</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ (–±–∞–∑–∞) */
        body { 
            font-family: 'Inter', sans-serif; 
            max-width: 800px; 
            margin: 20px auto; 
            background: #f3f4f6; 
            color: #1f2937; 
            padding: 10px; 
            line-height: 1.5; 
        }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .post { background: white; padding: 15px; margin-bottom: 15px; border-radius: 16px; border-left: 6px solid #4f46e5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; box-sizing: border-box; font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iPhone */ }
        button { background: #4f46e5; color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 600; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        
        .hidden { display: none !important; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .avatar { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 12px; flex-shrink: 0; }
        
        #chatHistory { height: 400px; overflow-y: auto; border: 1px solid #f3f4f6; padding: 15px; background: #ffffff; display: flex; flex-direction: column; margin-bottom: 10px; border-radius: 12px; }
        #typingIndicator {
            font-size: 0.85em; 
            color: #4f46e5; 
            height: 20px; 
            font-style: italic; 
            font-weight: 600; 
            margin-bottom: 8px;
            padding-left: 5px;
        }
        .msg { margin-bottom: 10px; padding: 10px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; }
        .msg-in { background: #f3f4f6; align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg-out { background: #4f46e5; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .status-bar { font-size: 11px; color: gray; text-align: right; margin-bottom: 10px; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–µ–Ω—é –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .main-layout { display: flex; gap: 20px; }
        .sidebar {
            display: flex;
            flex-direction: column; /* –ù–∞ –ü–ö ‚Äî –≤ —Å—Ç–æ–ª–±–∏–∫ */
            width: 160px;
            flex-shrink: 0;
        }
        .sidebar button {
            background: #e4e6eb; /* –°–ø–æ–∫–æ–π–Ω—ã–π —Å–µ—Ä—ã–π —Ü–≤–µ—Ç */
            color: black;
            margin-bottom: 10px;
            padding: 12px;       /* –û–¥–∏–Ω–∞–∫–æ–≤—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –≤—Å–µ—Ö */
            height: 45px;        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–µ ¬´–≥—É–ª—è–ª–∏¬ª */
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .sidebar button:hover {
            background: #d8dadf;
        }
        .content-area { flex-grow: 1; }

        /* --- –ê–î–ê–ü–¢–ò–í –ü–û–î –¢–ï–õ–ï–§–û–ù–´ --- */
        /* --- –ê–î–ê–ü–¢–ò–í –ü–û–î –¢–ï–õ–ï–§–û–ù–´ --- */
        @media (max-width: 600px) {
            body { margin: 0; padding: 10px; }
            
            .main-layout { flex-direction: column; gap: 10px; }
            
            .sidebar {
                width: 100%; 
                flex-direction: row; 
                gap: 8px; /* –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ú–ï–ñ–î–£ –∫–Ω–æ–ø–∫–∞–º–∏ –±—É–¥–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω–æ —Å–∫–≤–æ–∑–Ω—ã–º */
                position: sticky; 
                top: 0;
                z-index: 100;
                
                /* –£–±–∏—Ä–∞–µ–º –≤—Å—ë –ª–∏—à–Ω–µ–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—É—Å—Ç–æ—Ç—É */
                background: transparent !important; 
                box-shadow: none !important;
                padding: 10px 0;
                margin: 0;
            }

            .sidebar button {
                /* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
                background: rgba(255, 255, 255, 0.7) !important; 
                backdrop-filter: blur(12px); 
                -webkit-backdrop-filter: blur(12px);
                
                color: #1f2937;
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                
                margin-bottom: 0; 
                flex: 1;           
                height: 44px;      
                font-size: 13px;
                border-radius: 12px;
                font-weight: 600;
            }
            
            /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
            .sidebar button:active {
                background: rgba(255, 255, 255, 0.9) !important;
                transform: scale(0.96);
            }

            .header h2 { font-size: 1.2rem; }
            .card { padding: 15px; }
            #chatHistory { height: 65vh; }
            
            /* –ß—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª –∫ –∫–Ω–æ–ø–∫–∞–º —Å–≤–µ—Ä—Ö—É –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
            .content-area { padding-top: 5px; }
            .post { padding: 12px; }
            .post p { padding-left: 0; margin-top: 10px; } /* –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –ø–æ–¥ –∞–≤–∞—Ç–∞—Ä–∫–æ–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ */
        }
    </style>
</head>
<body>
    <div class="status-bar">–°–µ—Ç—å: <span id="netStatus">...</span> | <span id="peerCount">0</span> –ø–∏—Ä–æ–≤</div>

    <div id="authSection" class="card">
        <div id="loginForm">
            <h2>–í—Ö–æ–¥ P2P</h2>
            <input type="text" id="loginAlias" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <p style="text-align:center">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="toggleAuth()">–°–æ–∑–¥–∞—Ç—å</a></p>
        </div>
        <div id="registerForm" class="hidden">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Web3</h2>
            <input type="text" id="regAlias" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="regPass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="register()" style="background: #42b72a;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <p style="text-align:center">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="toggleAuth()">–í–æ–π—Ç–∏</a></p>
        </div>
    </div>

    <div id="userSection" class="hidden">
        <div class="header">
            <h2 id="welcomeMsg">–ü—Ä–∏–≤–µ—Ç!</h2>
            <button onclick="logout()" style="width: auto; background: #606770; padding: 8px 15px;">–í—ã–π—Ç–∏</button>
        </div>

        <div class="main-layout">
            <div class="sidebar">
                <button onclick="showFeed()" id="btn-feed" style="margin-bottom: 10px;">–õ–µ–Ω—Ç–∞</button>
                <button onclick="showMyProfile()" id="btn-profile" style="margin-bottom: 10px;">–ü—Ä–æ—Ñ–∏–ª—å</button>
                <button onclick="showChats()" id="btn-msg">–°–æ–æ–±—â–µ–Ω–∏—è</button>
            </div>

            <div class="content-area">
                <h3 id="viewTitle">–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</h3>
                
                <div id="postFormCard" class="card">
                    <textarea id="postContent" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"></textarea>
                    <button onclick="sendPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ P2P</button>
                </div>

                <div id="feed"></div>

                <div id="chatsListSection" class="card hidden">
                    <p>–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã:</p>
                    <input type="text" id="targetRoom" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
                    <button onclick="openChat(document.getElementById('targetRoom').value)">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
                    
                    <div id="recentChatsSection" style="margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px;">
                        <p style="font-size: 0.85em; color: #6b7280; margin-bottom: 10px; font-weight: 600;">–ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:</p>
                        <div id="recentChatsList" style="display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>
                </div>

                <div id="activeChatSection" class="card hidden">
                    <button onclick="showChats()" style="width: auto; padding: 6px 12px; margin-bottom: 15px; background: #e4e6eb; color: #333;">‚Üê –ù–∞–∑–∞–¥</button>
                    <div id="chatHistory"></div>
                    <div id="typingIndicator"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="msgContent" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="handleTyping()" onkeydown="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()" style="width: auto; padding: 0 20px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                <div id="profileSection" class="card hidden">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                        <div id="profileAvatar" class="avatar" style="width: 80px; height: 80px; font-size: 2em; margin: 0; display: flex; align-items: center; justify-content: center; color: white; border-radius: 50%;"></div>
                        
                        <div style="text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <h2 id="profileName" style="margin: 0;">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                                <div id="onlineStatusBadge" title="–°—Ç–∞—Ç—É—Å" style="width: 12px; height: 12px; border-radius: 50%; background: gray; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.1); transition: background 0.3s ease;"></div>
                            </div>
                            <div id="lastSeenText" style="font-size: 0.75em; color: gray; margin-top: 4px;"></div>
                        </div>

                        <div style="width: 100%; text-align: left;">
                            <label style="font-size: 0.8em; color: gray;">–û —Å–µ–±–µ:</label>
                            <textarea id="profileBioInput" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –æ —Å–µ–±–µ..." style="margin-top: 5px; height: 60px;"></textarea>
                            <button onclick="saveBio()" style="width: auto; padding: 5px 15px; font-size: 0.8em; background: #4f46e5;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
                        </div>

                        <div style="width: 100%; background: #f3f4f6; padding: 10px; border-radius: 12px; font-size: 0.8em; text-align: left;">
                            <details>
                                <summary style="cursor: pointer; color: #4b5563;">–ü–æ–∫–∞–∑–∞—Ç—å ID</summary>
                                <code id="profilePub" style="word-break: break-all; color: #4f46e5; display: block; margin-top: 5px;"></code>
                            </details>
                        </div>

                        <hr style="width: 100%; border: 0; border-top: 1px solid #eee; margin: 10px 0;">
                        
                        <div style="width: 100%; text-align: left;">
                            <h3 style="margin-bottom: 10px;">–ú–æ–∏ –ø–æ—Å—Ç—ã</h3>
                            <div id="myPostsContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const gun = Gun({ peers: ['https://my-p2p-relay.onrender.com/gun'] });
        const ADMIN_PUB = 'Poe8RvNoPuhLwkoBi_O97IxNNznOPPvNah_gufT5y8M.ydlAtR4OOz7jtvd6Y0lJy9c-Kb3CH_5MUJWB3RuhkKE';
        const user = gun.user().recall({storage: true});
        const globalFeed = gun.get('my-p2p-social-feed-v1');
        let currentRoom = null;
        let typingTimeout;
        let activeStatusListener = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è —Å—Ç–∞—Ç—É—Å–∞

        // AUTH
        async function login() {
            const alias = document.getElementById('loginAlias').value;
            const pass = document.getElementById('loginPass').value;
            if (!alias || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");
            user.leave();
            user.auth(alias, pass, (ack) => {
                if (ack.err) alert("–û—à–∏–±–∫–∞: " + ack.err);
                else showApp();
            });
        }
        async function register() {
            const alias = document.getElementById('regAlias').value;
            const pass = document.getElementById('regPass').value;
            if (alias.length < 3 || pass.length < 6) return alert("–õ–æ–≥–∏–Ω 3+, –ü–∞—Ä–æ–ª—å 6+");
            user.create(alias, pass, (ack) => {
                if (ack.err) alert("–û—à–∏–±–∫–∞: " + ack.err);
                else { alert("–°–æ–∑–¥–∞–Ω–æ! –í–æ–π–¥–∏—Ç–µ."); toggleAuth(); }
            });
        }
        async function showProfile(targetPub, targetAlias) {
            hideAll();
            
            const isItMe = user.is && targetPub === user.is.pub;
            
            document.getElementById('viewTitle').innerText = isItMe ? '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å' : '–ü—Ä–æ—Ñ–∏–ª—å ' + targetAlias;
            document.getElementById('profileSection').classList.remove('hidden');

            document.getElementById('profileName').innerText = targetAlias;
            document.getElementById('profilePub').innerText = targetPub || "ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
            
            const av = document.getElementById('profileAvatar');
            av.innerText = targetAlias ? targetAlias[0].toUpperCase() : "?";
            av.style.background = getAvatarColor(targetAlias || "anon");

            const bioInput = document.getElementById('profileBioInput');
            const bioBtn = document.getElementById('profileSection').querySelector('button'); 

            if (isItMe) {
                bioInput.readOnly = false;
                if (bioBtn) bioBtn.style.display = 'block';
            } else {
                bioInput.readOnly = true;
                if (bioBtn) bioBtn.style.display = 'none';
            }

            // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ó–ê–ì–õ–£–®–ö–ò ---
            // –°—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –Ω–µ –ø—É–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∑–∫–æ–π
            bioInput.value = isItMe ? "" : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ.";
            
            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞—à –ø—Ä–æ—Ñ–∏–ª—å, –ø—Ä–æ–±—É–µ–º –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ (–±—ã—Å—Ç—Ä–æ)
            if (isItMe) {
                user.get('profile').get('bio').once((data) => {
                    if (data) bioInput.value = data;
                });
            } else {
                // –ï—Å–ª–∏ —á—É–∂–æ–π, –∏—â–µ–º –≤ —Å–µ—Ç–∏. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–º ‚Äî —Ç–µ–∫—Å—Ç –æ–±–Ω–æ–≤–∏—Ç—Å—è —Å–∞–º.
                gun.user(targetPub).get('profile').get('bio').once((data) => {
                    if (data) bioInput.value = data;
                });
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã
            renderMyPosts(targetAlias);

            // --- –õ–û–ì–ò–ö–ê –û–ù–õ–ê–ô–ù–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø) ---
            const badge = document.getElementById('onlineStatusBadge');
            const lastSeenText = document.getElementById('lastSeenText');
            
            // 1. –ï—Å–ª–∏ –±—ã–ª —Å—Ç–∞—Ä—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º –µ–≥–æ, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–ª–∏—Å—å
            if (activeStatusListener) {
                activeStatusListener.off(); 
            }

            // 2. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤ –¥–µ—Ñ–æ–ª—Ç –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–≥–æ
            badge.style.background = '#9ca3af';
            lastSeenText.innerText = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';

            // 3. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            activeStatusListener = gun.user(targetPub).get('profile').get('lastSeen');
            
            activeStatusListener.on((time) => {
                const isOnline = Date.now() - time < 35000; 
                
                if (isOnline) {
                    badge.style.background = '#22c55e'; // –ó–µ–ª–µ–Ω—ã–π
                    lastSeenText.innerText = '–í —Å–µ—Ç–∏';
                } else {
                    badge.style.background = '#9ca3af'; // –°–µ—Ä—ã–π
                    const dateStr = time ? new Date(time).toLocaleString() : '–¥–∞–≤–Ω–æ';
                    lastSeenText.innerText = time ? `–ë—ã–ª(–∞) –≤ —Å–µ—Ç–∏: ${dateStr}` : '–ù–µ –≤ —Å–µ—Ç–∏';
                }
            });
        }
        user.recall({storage: true}, (ack) => { if (user.is) showApp(); });
        function showApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('welcomeMsg').innerText = `–ü—Ä–∏–≤–µ—Ç, ${user.is.alias}!`;
            showFeed();
            startHeartbeat();
        }
        function startHeartbeat() {
            if (!user.is) return;
            
            const updateStatus = () => {
                user.get('profile').get('lastSeen').put(Date.now());
            };
            
            updateStatus(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É
            setInterval(updateStatus, 10000); // –ò –ø–æ—Ç–æ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        }
        // FEED (–ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¢–£–¢)
        function sendPost() {
            const val = document.getElementById('postContent').value;
            if (!val || !user.is) return;
            
            const postId = Gun.text.random(16);
            
            globalFeed.get(postId).put({
                username: user.is.alias,
                pub: user.is.pub, // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –∞–≤—Ç–æ—Ä–∞
                content: val,
                time: Date.now(),
                id: postId
            });
            
            document.getElementById('postContent').value = '';
        }
        function showFeed() {
            hideAll();
            document.getElementById('viewTitle').innerText = '–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π';
            document.getElementById('postFormCard').classList.remove('hidden');
            const feedEl = document.getElementById('feed');
            feedEl.classList.remove('hidden');
            feedEl.innerHTML = '';

            let postsArray = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

            globalFeed.map().on((data, id) => {
                if (!data || data.content === null) {
                    const el = document.getElementById(id);
                    if (el) el.remove();
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞, –µ—Å–ª–∏ –ø–æ—Å—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω
                    postsArray = postsArray.filter(p => p.id !== id);
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ—Å—Ç–∞ —Å –µ–≥–æ ID
                const postData = { ...data, id: id };

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ—Å—Ç –≤ –º–∞—Å—Å–∏–≤–µ
                const existingIndex = postsArray.findIndex(p => p.id === id);
                if (existingIndex !== -1) {
                    postsArray[existingIndex] = postData; // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                } else {
                    postsArray.push(postData); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
                }

                // –°–û–†–¢–ò–†–û–í–ö–ê: –Ω–æ–≤—ã–µ (–±–æ–ª—å—à–µ–µ –≤—Ä–µ–º—è) –≤ –Ω–∞—á–∞–ª–æ
                postsArray.sort((a, b) => (b.time || 0) - (a.time || 0));

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ–π –ª–µ–Ω—Ç—ã –∑–∞–Ω–æ–≤–æ –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞
                // (–î–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –ª–µ–Ω—Ç —ç—Ç–æ –æ–∫, –¥–ª—è –≥–∏–≥–∞–Ω—Ç—Å–∫–∏—Ö –ø–æ—Ç–æ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º)
                renderFullFeed(postsArray);
            });
        }
        function renderFullFeed(posts) {
            const feedEl = document.getElementById('feed');
            feedEl.innerHTML = '';
            posts.forEach(p => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ—é —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é renderPost, 
                // –Ω–æ –Ω–µ–º–Ω–æ–≥–æ –∏–∑–º–µ–Ω–∏–º –µ—ë, —á—Ç–æ–±—ã –æ–Ω–∞ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ HTML –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–ª–∞ –≤ –∫–æ–Ω–µ—Ü
                appendPostToFeed(p, p.id);
            });
        }
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ç–≤–æ—é –ª–æ–≥–∏–∫—É –∫–Ω–æ–ø–æ–∫
        function appendPostToFeed(p, id) {
            const feed = document.getElementById('feed');
            // –ï—Å–ª–∏ pub –Ω–µ—Ç (—Å—Ç–∞—Ä—ã–π –ø–æ—Å—Ç), –ø–æ–ø—Ä–æ–±—É–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ –∏–º–µ–Ω–∏, –µ—Å–ª–∏ —ç—Ç–æ –º—ã
            const postPub = p.pub || (user.is && p.username === user.is.alias ? user.is.pub : null);
            
            const isMe = user.is && user.is.alias === p.username;
            const isAdmin = user.is && user.is.pub === ADMIN_PUB;

            const html = `<div class="post card" id="${id}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; ${postPub ? 'cursor:pointer;' : 'cursor:default;'}" 
                        onclick="${postPub ? `showProfile('${postPub}', '${p.username}')` : 'alert(\'–£ —ç—Ç–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ—Å—Ç–∞ –Ω–µ—Ç ID –∞–≤—Ç–æ—Ä–∞ –≤ –±–∞–∑–µ\')'}">
                        <div class="avatar" style="background:${getAvatarColor(p.username)}">${p.username[0]}</div>
                        <strong>${p.username}</strong>
                    </div>
                    ${(isMe || isAdmin) ? `<button onclick="deletePost('${id}')" style="width:auto; background:#fee2e2; color:#ef4444; border:none; padding:4px 12px; border-radius:8px; cursor:pointer; font-size:0.75em;">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                </div>
                <p style="padding-left:52px; margin:0;">${p.content}</p>
            </div>`;
            feed.insertAdjacentHTML('beforeend', html);
        }
        // CHAT & TYPING
        function handleTyping() {
            if (!currentRoom || !user.is) return;
            currentRoom.get('typing').get(user.is.alias).put(true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => { currentRoom.get('typing').get(user.is.alias).put(false); }, 2000);
        }
        function listenTyping(roomName) {
            const ind = document.getElementById('typingIndicator');
            gun.get('room-' + roomName).get('typing').map().on((is, alias) => {
                if (!user.is || alias === user.is.alias) return;
                ind.innerText = is ? alias + " –ø–µ—á–∞—Ç–∞–µ—Ç..." : "";
            });
        }
        function openChat(name) {
            if(!name) return;
            saveToRecent(name);
            hideAll();
            
            document.getElementById('viewTitle').innerText = '–ß–∞—Ç: ' + name;
            document.getElementById('activeChatSection').classList.remove('hidden');
            
            const historyEl = document.getElementById('chatHistory');
            historyEl.innerHTML = ''; 
            
            // –ï—Å–ª–∏ –º—ã —É–∂–µ –±—ã–ª–∏ –≤ –∫–∞–∫–æ–π-—Ç–æ –∫–æ–º–Ω–∞—Ç–µ, –æ—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –Ω–µ—ë (–µ—Å–ª–∏ Gun –ø–æ–∑–≤–æ–ª—è–µ—Ç)
            // –ù–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –≤ –ø—Ä–æ—Å—Ç–æ–º Gun - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ ID –≤ DOM
            
            currentRoom = gun.get('room-' + name);
            
            // –ß–∏—Å—Ç–∏–º –∫–∞—Ä—Ç—É –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –∑–∞–Ω–æ–≤–æ
            currentRoom.get('messages').map().on((data, id) => {
                if (!data || !data.content || document.getElementById(id)) return;
                renderMsg(data, id);
            });
            
            listenTyping(name);
        }
        function sendMessage() {
            const input = document.getElementById('msgContent');
            if (!input.value || !currentRoom) return;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —É–∑–µ–ª messages –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–Ω–∞—Ç—ã
            currentRoom.get('messages').set({ 
                sender: user.is.alias, 
                content: input.value, 
                time: Date.now() 
            });
            
            currentRoom.get('typing').get(user.is.alias).put(false);
            input.value = '';
        }
        function renderPost(p, id) {
            if (document.getElementById(id)) return;
            const feed = document.getElementById('feed');
            if (!feed) return;

            // –ü–†–û–í–ï–†–ö–ê: –∞–≤—Ç–æ—Ä –ø–æ—Å—Ç–∞ –ò–õ–ò —Ç–µ–∫—É—â–∏–π –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–π —é–∑–µ—Ä ‚Äî –∞–¥–º–∏–Ω
            const isMe = user.is && user.is.alias === p.username;
            const isAdmin = user.is && user.is.pub === ADMIN_PUB;

            const html = `<div class="post card" id="${id}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center;">
                        <div class="avatar" style="background:${getAvatarColor(p.username)}">${p.username[0]}</div>
                        <strong>${p.username}</strong>
                    </div>
                    ${(isMe || isAdmin) ? `<button onclick="deletePost('${id}')" style="width:auto; background:#fee2e2; color:#ef4444; border:none; padding:4px 12px; border-radius:8px; cursor:pointer; font-size:0.75em;">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                </div>
                <p style="padding-left:52px; margin:0;">${p.content}</p>
            </div>`;
            feed.insertAdjacentHTML('afterbegin', html);
        }
        function renderMsg(m, id) {
            const h = document.getElementById('chatHistory');
            const isMe = m.sender === user.is.alias;
            const isAdmin = user.is && user.is.pub === ADMIN_PUB; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞

            const d = document.createElement('div');
            d.id = id; 
            d.className = `msg ${isMe ? 'msg-out' : 'msg-in'}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞–ª–µ–Ω—å–∫—É—é –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞ —Ä—è–¥–æ–º —Å —á—É–∂–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            const delBtn = (isAdmin && !isMe) ? `<span onclick="deleteChatMessage('${id}')" style="cursor:pointer; margin-left:8px; opacity:0.5;">üóëÔ∏è</span>` : '';
            
            d.innerHTML = `${isMe ? '' : '<strong>'+m.sender+'</strong>: '}${m.content}${delBtn}`;
            h.appendChild(d); 
            h.scrollTop = h.scrollHeight;
        }
        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
        function deleteChatMessage(msgId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö?')) return;
            // –£–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å —á–µ—Ä–µ–∑ .get('messages')
            currentRoom.get('messages').get(msgId).put(null); 
            const el = document.getElementById(msgId);
            if (el) el.remove();
        }

        // HELPERS
        function hideAll() { 
            // –î–æ–±–∞–≤–∏–ª–∏ 'profileSection' –≤ —Å–ø–∏—Å–æ–∫ —Å–∫—Ä—ã—Ç–∏—è
            ['postFormCard', 'feed', 'chatsListSection', 'activeChatSection', 'profileSection'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            }); 
        }
        function getAvatarColor(n) { const c = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444']; let h = 0; for (let i=0; i<n.length; i++) h = n.charCodeAt(i) + ((h << 5) - h); return c[Math.abs(h) % c.length]; }
        function toggleAuth() { document.getElementById('loginForm').classList.toggle('hidden'); document.getElementById('registerForm').classList.toggle('hidden'); }
        function logout() { user.leave(); location.reload(); }
        function showChats() { hideAll(); document.getElementById('viewTitle').innerText = '–°–æ–æ–±—â–µ–Ω–∏—è'; document.getElementById('chatsListSection').classList.remove('hidden'); loadRecentChats();}
        function showMyProfile() {
            if (user.is) showProfile(user.is.pub, user.is.alias);
        }
        function renderMyPosts(username) {
            const container = document.getElementById('myPostsContainer');
            container.innerHTML = '<p style="color:gray; font-size:0.8em;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p>';
            
            let myPosts = [];
            
            // –ú—ã –±–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ globalFeed (—Ç–≤–æ—è –æ–±—â–∞—è –ª–µ–Ω—Ç–∞)
            globalFeed.once().map().once((data, id) => {
                if (data && data.username === username && data.content !== null) {
                    myPosts.push({...data, id: id});
                }
            });

            // –¢–∞–π–º-–∞—É—Ç, —á—Ç–æ–±—ã Gun —É—Å–ø–µ–ª —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (—Ç–∞–∫ –∫–∞–∫ .once().map() –∞—Å–∏–Ω—Ö—Ä–æ–Ω–µ–Ω)
            setTimeout(() => {
                container.innerHTML = '';
                if (myPosts.length === 0) {
                    container.innerHTML = '<p style="color:gray; font-size:0.8em;">–í—ã –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ—Å—Ç–∏–ª–∏.</p>';
                    return;
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
                myPosts.sort((a, b) => (b.time || 0) - (a.time || 0));
                
                myPosts.forEach(p => {
                    const postHtml = `
                        <div class="post card" style="margin-bottom: 10px; border-left: 4px solid ${getAvatarColor(p.username)};">
                            <p style="margin: 0; font-size: 0.9em;">${p.content}</p>
                            <small style="color: gray; font-size: 0.7em;">${new Date(p.time).toLocaleString()}</small>
                        </div>`;
                    container.insertAdjacentHTML('beforeend', postHtml);
                });
            }, 500);
        }
        function deletePost(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return;
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º null –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∞–¥—Ä–µ—Å—É –ø–æ—Å—Ç–∞
            globalFeed.get(id).put(null);
            
            // –î–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Å—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º –∏–∑ DOM
            const el = document.getElementById(id);
            if (el) el.remove();
        }
        function copyPub() {
            const pub = document.getElementById('profilePub').innerText;
            navigator.clipboard.writeText(pub).then(() => {
                alert("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
            });
        }
        // 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ "–û —Å–µ–±–µ" –≤ Gun.js
        function saveBio() {
            const bioText = document.getElementById('profileBioInput').value;
            if (!user.is) return;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ª–∏—á–Ω—ã–π —É–∑–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user.get('profile').get('bio').put(bioText, (ack) => {
                if (ack.err) alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
                else alert("–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!");
            });
        }
        setInterval(() => {
            if (gun && gun._ && gun._.opt && gun._.opt.peers) {
                const peers = Object.values(gun._.opt.peers).filter(p => p.wire && p.wire.readyState === 1);
                document.getElementById('peerCount').innerText = peers.length;
                document.getElementById('netStatus').innerText = peers.length > 0 ? "–û–ù–õ–ê–ô–ù" : "–ü–û–ò–°–ö...";
            }
        }, 2000);
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–Ω–∞—Ç—É –≤ P2P-–ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveToRecent(roomName) {
            if (!user.is || !roomName) return;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –∫–æ–º–Ω–∞—Ç—ã. Gun –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —ç—Ç–æ —Å —Ä–µ–ª–µ–µ–º
            user.get('recentRooms').get(roomName).put({
                name: roomName,
                timestamp: Date.now()
            });
        }
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫
        function loadRecentChats() {
            const listEl = document.getElementById('recentChatsList');
            if (!listEl || !user.is) return;
            
            listEl.innerHTML = ''; 

            user.get('recentRooms').map().on((data, name) => {
                if (!data || !data.name || document.getElementById('recent-' + name)) return;

                // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                const container = document.createElement('div');
                container.id = 'recent-' + name;
                container.style.cssText = `
                    position: relative; 
                    display: flex; 
                    align-items: center; 
                    background: #f9fafb; 
                    border: 1px solid #e5e7eb; 
                    border-radius: 12px; 
                    margin-bottom: 8px;
                    width: 100%; 
                    transition: all 0.2s;
                `;

                // –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ (—Å –±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º —Å–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –∑–∞–ª–µ–∑ –ø–æ–¥ –∫—Ä–µ—Å—Ç–∏–∫)
                const btn = document.createElement('button');
                btn.innerHTML = `<span style="color: #6366f1; font-weight: bold; margin-right: 8px;">#</span>${name}`;
                btn.style.cssText = `
                    width: 100%;
                    background: none; 
                    border: none; 
                    color: #1f2937; 
                    text-align: left; 
                    padding: 14px 50px 14px 16px; 
                    cursor: pointer; 
                    font-size: 0.95em;
                    font-weight: 500;
                `;
                
                btn.onclick = () => {
                    document.getElementById('targetRoom').value = name;
                    openChat(name);
                };

                // –ö–Ω–æ–ø–∫–∞-–∫—Ä–µ—Å—Ç–∏–∫ (–ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ü–†–ò–ñ–ê–¢–ê –í–ü–†–ê–í–û)
                const delBtn = document.createElement('button');
                delBtn.innerHTML = '‚úï';
                delBtn.style.cssText = `
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none; 
                    border: none; 
                    color: #d1d5db; 
                    cursor: pointer; 
                    padding: 10px;
                    font-size: 1.1em;
                    transition: color 0.2s;
                    z-index: 10;
                `;

                // –≠—Ñ—Ñ–µ–∫—Ç—ã
                container.onmouseover = () => {
                    container.style.borderColor = "#6366f1";
                    container.style.background = "#fff";
                    delBtn.style.color = "#9ca3af";
                };
                container.onmouseout = () => {
                    container.style.borderColor = "#e5e7eb";
                    container.style.background = "#f9fafb";
                    delBtn.style.color = "#d1d5db";
                };
                delBtn.onmouseover = (e) => { e.target.style.color = "#ef4444"; };

                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeRecentChat(name);
                };

                container.appendChild(btn);
                container.appendChild(delBtn);
                listEl.appendChild(container);
            });
        }
        function removeRecentChat(roomName) {
            if (!user.is || !roomName) return;
            
            // –í Gun.js —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—É—Ç–µ–º –∑–∞–ø–∏—Å–∏ null –≤ —É–∑–µ–ª
            user.get('recentRooms').get(roomName).put(null);
            
            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å—Ä–∞–∑—É
            const el = document.getElementById('recent-' + roomName);
            if (el) el.remove();
            
            console.log(`–ö–æ–º–Ω–∞—Ç–∞ ${roomName} —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞`);
        }
    </script>
</body>
</html>