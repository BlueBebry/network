<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–æ—è P2P –°–æ—Ü—Å–µ—Ç—å</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ (–±–∞–∑–∞) */
        body { 
            font-family: 'Inter', sans-serif; 
            max-width: 800px; 
            margin: 20px auto; 
            background: #f3f4f6; 
            color: #1f2937; 
            padding: 10px; 
            line-height: 1.5; 
        }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .post { background: white; padding: 15px; margin-bottom: 15px; border-radius: 16px; border-left: 6px solid #4f46e5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; box-sizing: border-box; font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iPhone */ }
        button { background: #4f46e5; color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 600; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        
        .hidden { display: none !important; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .avatar { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 12px; flex-shrink: 0; }
        
        #chatHistory { height: 400px; overflow-y: auto; border: 1px solid #f3f4f6; padding: 15px; background: #ffffff; display: flex; flex-direction: column; margin-bottom: 10px; border-radius: 12px; }
        #typingIndicator {
            font-size: 0.85em; 
            color: #4f46e5; 
            height: 20px; 
            font-style: italic; 
            font-weight: 600; 
            margin-bottom: 8px;
            padding-left: 5px;
        }
        .msg { margin-bottom: 10px; padding: 10px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; }
        .msg-in { background: #f3f4f6; align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg-out { background: #4f46e5; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .status-bar { font-size: 11px; color: gray; text-align: right; margin-bottom: 10px; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–µ–Ω—é –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .main-layout { display: flex; gap: 20px; }
        .sidebar {
            display: flex;
            flex-direction: column; /* –ù–∞ –ü–ö ‚Äî –≤ —Å—Ç–æ–ª–±–∏–∫ */
            width: 160px;
            flex-shrink: 0;
        }
        .sidebar button {
            background: #e4e6eb; /* –°–ø–æ–∫–æ–π–Ω—ã–π —Å–µ—Ä—ã–π —Ü–≤–µ—Ç */
            color: black;
            margin-bottom: 10px;
            padding: 12px;       /* –û–¥–∏–Ω–∞–∫–æ–≤—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –≤—Å–µ—Ö */
            height: 45px;        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–µ ¬´–≥—É–ª—è–ª–∏¬ª */
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .sidebar button:hover {
            background: #d8dadf;
        }
        .content-area { flex-grow: 1; }

        /* --- –ê–î–ê–ü–¢–ò–í –ü–û–î –¢–ï–õ–ï–§–û–ù–´ --- */
        /* --- –ê–î–ê–ü–¢–ò–í –ü–û–î –¢–ï–õ–ï–§–û–ù–´ --- */
        @media (max-width: 600px) {
            body { margin: 0; padding: 10px; }
            
            .main-layout { flex-direction: column; gap: 10px; }
            
            .sidebar {
                width: 100%; 
                flex-direction: row; 
                gap: 8px; /* –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ú–ï–ñ–î–£ –∫–Ω–æ–ø–∫–∞–º–∏ –±—É–¥–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω–æ —Å–∫–≤–æ–∑–Ω—ã–º */
                position: sticky; 
                top: 0;
                z-index: 100;
                
                /* –£–±–∏—Ä–∞–µ–º –≤—Å—ë –ª–∏—à–Ω–µ–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—É—Å—Ç–æ—Ç—É */
                background: transparent !important; 
                box-shadow: none !important;
                padding: 10px 0;
                margin: 0;
            }

            .sidebar button {
                /* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
                background: rgba(255, 255, 255, 0.7) !important; 
                backdrop-filter: blur(12px); 
                -webkit-backdrop-filter: blur(12px);
                
                color: #1f2937;
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                
                margin-bottom: 0; 
                flex: 1;           
                height: 44px;      
                font-size: 13px;
                border-radius: 12px;
                font-weight: 600;
            }
            
            /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
            .sidebar button:active {
                background: rgba(255, 255, 255, 0.9) !important;
                transform: scale(0.96);
            }

            .header h2 { font-size: 1.2rem; }
            .card { padding: 15px; }
            #chatHistory { height: 65vh; }
            
            /* –ß—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª –∫ –∫–Ω–æ–ø–∫–∞–º —Å–≤–µ—Ä—Ö—É –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
            .content-area { padding-top: 5px; }
            .post { padding: 12px; }
            .post p { padding-left: 0; margin-top: 10px; } /* –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –ø–æ–¥ –∞–≤–∞—Ç–∞—Ä–∫–æ–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ */
        }
    </style>
</head>
<body>
    <div class="status-bar">–°–µ—Ç—å: <span id="netStatus">...</span> | <span id="peerCount">0</span> –ø–∏—Ä–æ–≤</div>

    <div id="authSection" class="card">
        <div id="loginForm">
            <h2>–í—Ö–æ–¥ P2P</h2>
            <input type="text" id="loginAlias" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <p style="text-align:center">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="toggleAuth()">–°–æ–∑–¥–∞—Ç—å</a></p>
        </div>
        <div id="registerForm" class="hidden">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Web3</h2>
            <input type="text" id="regAlias" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="regPass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="register()" style="background: #42b72a;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <p style="text-align:center">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="toggleAuth()">–í–æ–π—Ç–∏</a></p>
        </div>
    </div>

    <div id="userSection" class="hidden">
        <div class="header">
            <h2 id="welcomeMsg">–ü—Ä–∏–≤–µ—Ç!</h2>
            <button onclick="logout()" style="width: auto; background: #606770; padding: 8px 15px;">–í—ã–π—Ç–∏</button>
        </div>

        <div class="main-layout">
            <div class="sidebar">
                <button onclick="showFeed()" id="btn-feed" style="margin-bottom: 10px;">–õ–µ–Ω—Ç–∞</button>
                <button onclick="showMyProfile()" id="btn-profile" style="margin-bottom: 10px;">–ü—Ä–æ—Ñ–∏–ª—å</button>
                <button onclick="showChats()" id="btn-msg">–°–æ–æ–±—â–µ–Ω–∏—è</button>
            </div>

            <div class="content-area">
                <h3 id="viewTitle">–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</h3>
                
                <div id="postFormCard" class="card">
                    <textarea id="postContent" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"></textarea>
                    <button onclick="sendPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ P2P</button>
                </div>

                <div id="feed"></div>

                <div id="chatsListSection" class="card hidden">
                    <p>–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã:</p>
                    <input type="text" id="targetRoom" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
                    <button onclick="openChat(document.getElementById('targetRoom').value)">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
                </div>

                <div id="activeChatSection" class="card hidden">
                    <button onclick="showChats()" style="width: auto; padding: 6px 12px; margin-bottom: 15px; background: #e4e6eb; color: #333;">‚Üê –ù–∞–∑–∞–¥</button>
                    <div id="chatHistory"></div>
                    <div id="typingIndicator"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="msgContent" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="handleTyping()" onkeydown="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()" style="width: auto; padding: 0 20px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                <div id="profileSection" class="card hidden">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                        <div id="profileAvatar" class="avatar" style="width: 80px; height: 80px; font-size: 2em; margin: 0; display: flex; align-items: center; justify-content: center; color: white; border-radius: 50%;"></div>
                        <h2 id="profileName" style="margin: 0;">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                        <div style="width: 100%; background: #f3f4f6; padding: 15px; border-radius: 12px; font-size: 0.9em; text-align: left;">
                            <p style="margin-bottom: 5px;"><strong>–í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π ID:</strong></p>
                            <code id="profilePub" style="word-break: break-all; color: #4f46e5; display: block; background: white; padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb;"></code>
                            <button onclick="copyPub()" style="margin-top: 10px; background: #e4e6eb; color: #1f2937; font-size: 0.8em; padding: 5px 10px; width: auto;">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
                        </div>
                        <p style="color: gray; font-size: 0.8em; margin: 0;">–≠—Ç–æ—Ç ID —É–Ω–∏–∫–∞–ª–µ–Ω –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤–∞—à—É –ª–∏—á–Ω–æ—Å—Ç—å –≤ P2P —Å–µ—Ç–∏.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const gun = Gun({ peers: ['https://my-p2p-relay.onrender.com/gun'] });
        const ADMIN_PUB = 'Zh8npbdquBdVDtKm_JPh5IN7Lusq7V9DIMHZZqRgX_g.EF23noK_Fs0USXGJmH3P9GGfel2goGF8EKMtm53Y5sE';
        const user = gun.user().recall({storage: true});
        const globalFeed = gun.get('my-p2p-social-feed-v1');
        let currentRoom = null;
        let typingTimeout;

        // AUTH
        async function login() {
            const alias = document.getElementById('loginAlias').value;
            const pass = document.getElementById('loginPass').value;
            if (!alias || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");
            user.leave();
            user.auth(alias, pass, (ack) => {
                if (ack.err) alert("–û—à–∏–±–∫–∞: " + ack.err);
                else showApp();
            });
        }
        async function register() {
            const alias = document.getElementById('regAlias').value;
            const pass = document.getElementById('regPass').value;
            if (alias.length < 3 || pass.length < 6) return alert("–õ–æ–≥–∏–Ω 3+, –ü–∞—Ä–æ–ª—å 6+");
            user.create(alias, pass, (ack) => {
                if (ack.err) alert("–û—à–∏–±–∫–∞: " + ack.err);
                else { alert("–°–æ–∑–¥–∞–Ω–æ! –í–æ–π–¥–∏—Ç–µ."); toggleAuth(); }
            });
        }
        user.recall({storage: true}, (ack) => { if (user.is) showApp(); });
        function showApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('welcomeMsg').innerText = `–ü—Ä–∏–≤–µ—Ç, ${user.is.alias}!`;
            showFeed();
        }

        // FEED (–ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¢–£–¢)
        function sendPost() {
            const val = document.getElementById('postContent').value;
            if (!val) return;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –ø–æ—Å—Ç–∞ —Å–∞–º–∏
            const postId = Gun.text.random(16);
            
            // –ü—É–±–ª–∏–∫—É–µ–º –≤ –ª–µ–Ω—Ç—É –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–ª—é—á—É
            globalFeed.get(postId).put({
                username: user.is.alias,
                content: val,
                time: Date.now(),
                id: postId // —Å–æ—Ö—Ä–∞–Ω—è–µ–º id –≤–Ω—É—Ç—Ä–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            });
            
            document.getElementById('postContent').value = '';
        }
        function showFeed() {
            hideAll();
            document.getElementById('viewTitle').innerText = '–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π';
            document.getElementById('postFormCard').classList.remove('hidden');
            const feedEl = document.getElementById('feed');
            feedEl.classList.remove('hidden');
            feedEl.innerHTML = '';

            let postsArray = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

            globalFeed.map().on((data, id) => {
                if (!data || data.content === null) {
                    const el = document.getElementById(id);
                    if (el) el.remove();
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞, –µ—Å–ª–∏ –ø–æ—Å—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω
                    postsArray = postsArray.filter(p => p.id !== id);
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ—Å—Ç–∞ —Å –µ–≥–æ ID
                const postData = { ...data, id: id };

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ—Å—Ç –≤ –º–∞—Å—Å–∏–≤–µ
                const existingIndex = postsArray.findIndex(p => p.id === id);
                if (existingIndex !== -1) {
                    postsArray[existingIndex] = postData; // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                } else {
                    postsArray.push(postData); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
                }

                // –°–û–†–¢–ò–†–û–í–ö–ê: –Ω–æ–≤—ã–µ (–±–æ–ª—å—à–µ–µ –≤—Ä–µ–º—è) –≤ –Ω–∞—á–∞–ª–æ
                postsArray.sort((a, b) => (b.time || 0) - (a.time || 0));

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ–π –ª–µ–Ω—Ç—ã –∑–∞–Ω–æ–≤–æ –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞
                // (–î–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –ª–µ–Ω—Ç —ç—Ç–æ –æ–∫, –¥–ª—è –≥–∏–≥–∞–Ω—Ç—Å–∫–∏—Ö –ø–æ—Ç–æ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º)
                renderFullFeed(postsArray);
            });
        }
        function renderFullFeed(posts) {
            const feedEl = document.getElementById('feed');
            feedEl.innerHTML = '';
            posts.forEach(p => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ—é —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é renderPost, 
                // –Ω–æ –Ω–µ–º–Ω–æ–≥–æ –∏–∑–º–µ–Ω–∏–º –µ—ë, —á—Ç–æ–±—ã –æ–Ω–∞ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ HTML –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è–ª–∞ –≤ –∫–æ–Ω–µ—Ü
                appendPostToFeed(p, p.id);
            });
        }
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ç–≤–æ—é –ª–æ–≥–∏–∫—É –∫–Ω–æ–ø–æ–∫
        function appendPostToFeed(p, id) {
            const feed = document.getElementById('feed');
            const isMe = user.is && user.is.alias === p.username;
            const isAdmin = user.is && user.is.pub === ADMIN_PUB;

            const html = `<div class="post card" id="${id}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center;">
                        <div class="avatar" style="background:${getAvatarColor(p.username)}">${p.username[0]}</div>
                        <strong>${p.username}</strong>
                    </div>
                    ${(isMe || isAdmin) ? `<button onclick="deletePost('${id}')" style="width:auto; background:#fee2e2; color:#ef4444; border:none; padding:4px 12px; border-radius:8px; cursor:pointer; font-size:0.75em;">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                </div>
                <p style="padding-left:52px; margin:0;">${p.content}</p>
            </div>`;
            feed.insertAdjacentHTML('beforeend', html); // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–π –æ—á–µ—Ä–µ–¥–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        }
        // CHAT & TYPING
        function handleTyping() {
            if (!currentRoom || !user.is) return;
            currentRoom.get('typing').get(user.is.alias).put(true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => { currentRoom.get('typing').get(user.is.alias).put(false); }, 2000);
        }
        function listenTyping(roomName) {
            const ind = document.getElementById('typingIndicator');
            gun.get('room-' + roomName).get('typing').map().on((is, alias) => {
                if (!user.is || alias === user.is.alias) return;
                ind.innerText = is ? alias + " –ø–µ—á–∞—Ç–∞–µ—Ç..." : "";
            });
        }
        function openChat(name) {
            if(!name) return;
            hideAll();
            
            document.getElementById('viewTitle').innerText = '–ß–∞—Ç: ' + name;
            document.getElementById('activeChatSection').classList.remove('hidden');
            
            const historyEl = document.getElementById('chatHistory');
            historyEl.innerHTML = ''; 
            
            // –ï—Å–ª–∏ –º—ã —É–∂–µ –±—ã–ª–∏ –≤ –∫–∞–∫–æ–π-—Ç–æ –∫–æ–º–Ω–∞—Ç–µ, –æ—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –Ω–µ—ë (–µ—Å–ª–∏ Gun –ø–æ–∑–≤–æ–ª—è–µ—Ç)
            // –ù–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –≤ –ø—Ä–æ—Å—Ç–æ–º Gun - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ ID –≤ DOM
            
            currentRoom = gun.get('room-' + name);
            
            // –ß–∏—Å—Ç–∏–º –∫–∞—Ä—Ç—É –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –∑–∞–Ω–æ–≤–æ
            currentRoom.get('messages').map().on((data, id) => {
                if (!data || !data.content || document.getElementById(id)) return;
                renderMsg(data, id);
            });
            
            listenTyping(name);
        }
        function sendMessage() {
            const input = document.getElementById('msgContent');
            if (!input.value || !currentRoom) return;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —É–∑–µ–ª messages –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–Ω–∞—Ç—ã
            currentRoom.get('messages').set({ 
                sender: user.is.alias, 
                content: input.value, 
                time: Date.now() 
            });
            
            currentRoom.get('typing').get(user.is.alias).put(false);
            input.value = '';
        }
        function renderPost(p, id) {
            if (document.getElementById(id)) return;
            const feed = document.getElementById('feed');
            if (!feed) return;

            // –ü–†–û–í–ï–†–ö–ê: –∞–≤—Ç–æ—Ä –ø–æ—Å—Ç–∞ –ò–õ–ò —Ç–µ–∫—É—â–∏–π –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–π —é–∑–µ—Ä ‚Äî –∞–¥–º–∏–Ω
            const isMe = user.is && user.is.alias === p.username;
            const isAdmin = user.is && user.is.pub === ADMIN_PUB;

            const html = `<div class="post card" id="${id}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center;">
                        <div class="avatar" style="background:${getAvatarColor(p.username)}">${p.username[0]}</div>
                        <strong>${p.username}</strong>
                    </div>
                    ${(isMe || isAdmin) ? `<button onclick="deletePost('${id}')" style="width:auto; background:#fee2e2; color:#ef4444; border:none; padding:4px 12px; border-radius:8px; cursor:pointer; font-size:0.75em;">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                </div>
                <p style="padding-left:52px; margin:0;">${p.content}</p>
            </div>`;
            feed.insertAdjacentHTML('afterbegin', html);
        }
        function renderMsg(m, id) {
            const h = document.getElementById('chatHistory');
            const isMe = m.sender === user.is.alias;
            const isAdmin = user.is && user.is.pub === ADMIN_PUB; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞

            const d = document.createElement('div');
            d.id = id; 
            d.className = `msg ${isMe ? 'msg-out' : 'msg-in'}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞–ª–µ–Ω—å–∫—É—é –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞ —Ä—è–¥–æ–º —Å —á—É–∂–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            const delBtn = (isAdmin && !isMe) ? `<span onclick="deleteChatMessage('${id}')" style="cursor:pointer; margin-left:8px; opacity:0.5;">üóëÔ∏è</span>` : '';
            
            d.innerHTML = `${isMe ? '' : '<strong>'+m.sender+'</strong>: '}${m.content}${delBtn}`;
            h.appendChild(d); 
            h.scrollTop = h.scrollHeight;
        }
        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
        function deleteChatMessage(msgId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö?')) return;
            // –£–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å —á–µ—Ä–µ–∑ .get('messages')
            currentRoom.get('messages').get(msgId).put(null); 
            const el = document.getElementById(msgId);
            if (el) el.remove();
        }

        // HELPERS
        function hideAll() { 
            // –î–æ–±–∞–≤–∏–ª–∏ 'profileSection' –≤ —Å–ø–∏—Å–æ–∫ —Å–∫—Ä—ã—Ç–∏—è
            ['postFormCard', 'feed', 'chatsListSection', 'activeChatSection', 'profileSection'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            }); 
        }
        function getAvatarColor(n) { const c = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444']; let h = 0; for (let i=0; i<n.length; i++) h = n.charCodeAt(i) + ((h << 5) - h); return c[Math.abs(h) % c.length]; }
        function toggleAuth() { document.getElementById('loginForm').classList.toggle('hidden'); document.getElementById('registerForm').classList.toggle('hidden'); }
        function logout() { user.leave(); location.reload(); }
        function showChats() { hideAll(); document.getElementById('viewTitle').innerText = '–°–æ–æ–±—â–µ–Ω–∏—è'; document.getElementById('chatsListSection').classList.remove('hidden'); }
        function showMyProfile() {
            hideAll();
            if (!user.is) return;

            document.getElementById('viewTitle').innerText = '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å';
            document.getElementById('profileSection').classList.remove('hidden');

            const name = user.is.alias;
            const pub = user.is.pub;

            document.getElementById('profileName').innerText = name;
            document.getElementById('profilePub').innerText = pub;
            
            const av = document.getElementById('profileAvatar');
            av.innerText = name[0].toUpperCase();
            av.style.background = getAvatarColor(name);
        }
        function deletePost(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return;
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º null –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∞–¥—Ä–µ—Å—É –ø–æ—Å—Ç–∞
            globalFeed.get(id).put(null);
            
            // –î–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Å—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º –∏–∑ DOM
            const el = document.getElementById(id);
            if (el) el.remove();
        }
        function copyPub() {
            const pub = document.getElementById('profilePub').innerText;
            navigator.clipboard.writeText(pub).then(() => {
                alert("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
            });
        }
        setInterval(() => {
            if (gun && gun._ && gun._.opt && gun._.opt.peers) {
                const peers = Object.values(gun._.opt.peers).filter(p => p.wire && p.wire.readyState === 1);
                document.getElementById('peerCount').innerText = peers.length;
                document.getElementById('netStatus').innerText = peers.length > 0 ? "–û–ù–õ–ê–ô–ù" : "–ü–û–ò–°–ö...";
            }
        }, 2000);
    </script>
</body>
</html>