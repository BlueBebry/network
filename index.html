<!DOCTYPE html>
<html>
<head>
    <title>Web3 P2P Network</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; padding: 20px; background: #f3f4f6; max-width: 500px; margin: auto; }
        .box { background: white; padding: 20px; border-radius: 12px; shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; border-radius: 8px; border: 1px solid #ddd; }
        button { width: 100%; padding: 10px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        #messages { list-style: none; padding: 0; }
        li { background: white; padding: 10px; margin-bottom: 5px; border-radius: 8px; border-left: 4px solid #4f46e5; }
        .status { font-size: 0.8em; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="auth" class="box">
        <h3>Войти в Web3</h3>
        <input id="alias" placeholder="Логин">
        <input id="pass" type="password" placeholder="Пароль">
        <button onclick="signUp()">Создать аккаунт</button>
        <button onclick="signIn()" style="background:#10b981">Войти</button>
        <p style="font-size: 0.7em;">*Пароль нельзя восстановить, он генерирует ваш ключ.</p>
    </div>

    <div id="app" class="box" style="display:none">
        <h3 id="userTitle"></h3>
        <div class="status">Статус: <span id="netStatus">Подключение...</span></div>
        <input id="content" placeholder="Что нового?">
        <button onclick="send()">Опубликовать в P2P</button>
        <ul id="messages"></ul>
    </div>

    <script>
        const gun = Gun([
            'https://gun-manhattan.herokuapp.com/gun',
            'https://peer.wall.gl/gun'
        ]);
        const user = gun.user().recall({storage: true});

        // Функция для обновления интерфейса
        function updateUI() {
            if (user.is) {
                document.getElementById('auth').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('userTitle').innerText = "Вы в сети как: " + user.is.alias;
                loadMessages();
            }
        }

        // Регистрация
        async function signUp() {
            const alias = document.getElementById('alias').value;
            const pass = document.getElementById('pass').value;
            user.create(alias, pass, (ack) => {
                if (ack.err) {
                    alert("Ошибка регистрации: " + ack.err);
                } else {
                    alert("Аккаунт создан! Теперь нажмите 'Войти'");
                }
            });
        }

        // Вход
        function signIn() {
            const alias = document.getElementById('alias').value;
            const pass = document.getElementById('pass').value;
            user.auth(alias, pass, (ack) => {
                if (ack.err) {
                    alert("Ошибка входа: " + ack.err);
                } else {
                    console.log("Авторизация успешна!");
                    updateUI(); // Показываем чат без перезагрузки
                }
            });
        }

        // Загрузка сообщений
        function loadMessages() {
            gun.get('shared-web3-feed-v3').map().on((data, id) => {
                if (!data || !data.text) return;
                // Проверяем, нет ли уже такого сообщения на экране
                if (!document.getElementById(id)) {
                    const li = document.createElement('li');
                    li.id = id;
                    li.innerHTML = `<strong>${data.from}:</strong> ${data.text}`;
                    document.getElementById('messages').prepend(li);
                }
            });
        }

        // Проверяем статус при загрузке
        updateUI();

        function send() {
            const text = document.getElementById('content').value;
            if (!text || !user.is) return;
            
            gun.get('shared-web3-feed-v3').set({
                text: text,
                from: user.is.alias,
                time: Date.now()
            });
            document.getElementById('content').value = '';
        }
    </script>
</body>
</html>